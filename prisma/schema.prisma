generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model MediaAsset {
  id             String   @id @default(uuid())
  sourceHash     String           @unique
  sourceUrl      String
  kind           String
  mime           String
  durationSec    Int?
  width          Int?
  height         Int?
  isVertical     Boolean          @default(false)
  storagePath    String
  sizeBytes      Int              @default(0)
  status         String           @default("PROCESSING")
  error          String?
  lastAccessedAt DateTime         @default(now())
  expiresAt      DateTime
  createdAt      DateTime         @default(now())

  playbackJobs PlaybackJob[]
  memeBoardItems MemeBoardItem[]

  @@index([expiresAt])
  @@index([status])
}

model MemeBoardItem {
  id                    String   @id @default(uuid())
  guildId               String
  mediaAssetId          String
  mediaAsset            MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
  title                 String?
  createdByDiscordUserId String?
  createdByName         String?
  createdAt             DateTime @default(now())

  @@unique([guildId, mediaAssetId])
  @@index([guildId, createdAt])
  @@index([mediaAssetId])
}

model PlaybackJob {
  id         String  @id @default(uuid())
  guildId    String
  mediaAssetId String?
  mediaAsset MediaAsset?       @relation(fields: [mediaAssetId], references: [id], onDelete: SetNull)

  text      String?
  showText  Boolean            @default(false)
  authorName  String?
  authorImage String?

  durationSec  Int
  priority     Int      @default(0)
  status       String   @default("PENDING")
  resumesAfterJobId String?
  resumeOffsetSec Int? @default(0)
  remainingMsSnapshot Int?
  lastPlaybackStateAt DateTime?

  submissionDate DateTime @default(now())
  executionDate  DateTime @default(now())
  scheduledAt    DateTime @default(now())
  startedAt      DateTime?
  finishedAt     DateTime?

  @@index([guildId, executionDate])
  @@index([status, executionDate])
  @@index([guildId, mediaAssetId])
  @@index([status, finishedAt])
  @@index([guildId, status, priority, submissionDate])
  @@index([guildId, status, resumesAfterJobId])
}

model Guild {
  id               String    @id
  busyUntil        DateTime?
  defaultMediaTime Int?
  maxMediaTime     Int?
  displayMediaFull Boolean   @default(false)
}

model OverlayClient {
  id         String   @id @default(uuid())
  guildId    String
  label      String
  tokenHash  String   @unique
  defaultAuthorName     String?
  defaultAuthorImage    String?
  createdByDiscordUserId String?
  lastSeenAt DateTime?
  createdAt  DateTime @default(now())
  revokedAt  DateTime?

  @@index([guildId])
}

model IngestClient {
  id                    String   @id @default(uuid())
  guildId               String
  label                 String
  tokenHash             String   @unique
  defaultAuthorName     String
  defaultAuthorImage    String?
  createdByDiscordUserId String
  lastSeenAt            DateTime?
  createdAt             DateTime @default(now())
  revokedAt             DateTime?

  @@index([guildId])
}

model PairingCode {
  code                   String   @id
  guildId                String
  createdByDiscordUserId String
  authorName             String?
  authorImage            String?
  expiresAt              DateTime
  usedAt                 DateTime?
  createdAt              DateTime @default(now())

  @@index([guildId, expiresAt])
  @@index([expiresAt])
}
